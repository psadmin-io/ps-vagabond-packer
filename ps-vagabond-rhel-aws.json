{
  "description": "Packer template for ps-vagabond base box",
  "_comment": "Build with `packer build ps-vagabond-oel.json`",
  "variables": {
    "cpus": "1",
    "volume_size": "20",
    "kickstart": "ks7.cfg",
    "memory": "512",
    "source_ami": "ami-2051294a",
    "subnet_id": "",
    "packer_base": "{{env `PACKER_BASE`}}",
    "shutdown_command": "echo 'vagrant'|sudo -S shutdown -P now",
    "ssh_username": "ec2-user",
    "version": "1.0.0",
    "access_key": "{{env `AWS_ACCESS_KEY`}}",
    "secret_key": "{{env `AWS_SECRET_KEY`}}",
    "ssh_key_name": "{{env `AWS_KEY_NAME`}}",
    "ssh_key_file": "{{env `AWS_KEY_FILE`}}"
  },
  "builders": [{
    "type": "amazon-ebs",
    "region": "us-east-1",
    "source_ami": "{{ user `source_ami`}}",
    "instance_type": "t2.large",
    "ami_name": "ps-vagabond-rhel-1.0.0 {{timestamp}}",
    "ssh_keypair_name": "{{ user `ssh_key_name` }}",
    "ssh_private_key_file": "{{ user `ssh_key_file` }}",
    "ssh_username": "{{ user `ssh_username` }}",
    "ssh_pty" : true,
    "user_data_file":"./scripts/aws/userdata.sh",
    "associate_public_ip_address":true,
    "subnet_id": "subnet-18ae5e53",
    "access_key": "{{user `access_key`}}",
    "secret_key": "{{user `secret_key`}}",
    "tags": {
      "OS_Version": "RHEL",
      "Release": "PeopleSoft Image"
    },
    "launch_block_device_mappings": [{
      "device_name": "/dev/sda1",
      "volume_size": "{{ user `volume_size` }}",
      "volume_type": "gp2",
      "encrypted": false,
      "delete_on_termination": true
    }],
    "ami_block_device_mappings": [{
      "device_name": "/dev/sda1",
      "volume_size": "{{ user `volume_size` }}",
      "volume_type": "gp2",
      "encrypted": false,
      "delete_on_termination": true
    }]
  }],
  "provisioners": [{
    "environment_vars": [
      "SSH_USERNAME={{ user `ssh_username` }}",
      "SSH_PASSWORD={{ user `ssh_password` }}"
    ],
    "execute_command": "echo 'vagrant' | {{.Vars}} sudo -E -S bash '{{.Path}}'",
    "scripts": [
      "scripts/oel/kernel.sh",
      "scripts/oel/sshd.sh",
      "scripts/oel/epel.sh",
      "scripts/oel/update.sh",
      "scripts/oel/aria.sh",
      "scripts/oel/vagrant.sh",
      "scripts/oel/virtualbox.sh",
      "scripts/oel/motd.sh",
      "scripts/oel/cleanup.sh"
    ],
    "type": "shell"
  }]
}